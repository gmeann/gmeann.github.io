<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ ì¿ í‚¤ í« í‚¤ìš°ê¸°</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'negative-lg': '0 -10px 15px -3px rgba(0, 0, 0, 0.1), 0 -4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .animate-bounce-slow {
            animation: bounce-slow 3s infinite ease-in-out;
        }
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
    </div>

    <!-- Lucide Icons -->
    <script type="module">
        import { createIcons, Settings, Sparkles, RefreshCw, Lock, User, Key, Save, Smile, MessageSquare, Edit3 } from 'https://unpkg.com/lucide@latest/dist/esm/lucide.js';
        // ì•„ì´ì½˜ í•¨ìˆ˜ë“¤ì„ globalStateì— ì €ì¥
        // ì´ ëª¨ë“ˆì€ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë¡œë“œë˜ë¯€ë¡œ, ì•„ì´ì½˜ ì‚¬ìš© ì‹œì ì— í•¨ìˆ˜ê°€ í• ë‹¹ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
        window.lucide = { Settings, Sparkles, RefreshCw, Lock, User, Key, Save, Smile, MessageSquare, Edit3 };
        window.createLucideIcons = () => createIcons({ icons: window.lucide, attrs: { class: 'lucide' } });
    </script>

    <!-- Firebase SDK Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore ë¡œê·¸ ë ˆë²¨ ì„¤ì • (ë””ë²„ê¹…ìš©)
        setLogLevel('Debug');
        
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì • (Canvas í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let appInstance, auth, db;
        let globalState = {
            user: null,
            view: 'intro', // intro, test, naming, main
            loading: false,
            studentCode: '',
            cookies: 0,
            globalSettings: { apiKey: '', thresholds: [0, 10, 30, 60, 100] },
            myPet: null,
            petName: '',
            petLevel: 0,
            message: '',
            showMoodCheck: false,
            showAdminLogin: false,
            showAdminSettings: false,
            adminPasswordInput: '',
            adminApiKeyInput: '',
            adminThresholdsInput: [0, 10, 30, 60, 100],
            testStep: 0,
            testScores: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
            inputName: '',
            imageError: false,
            syncIntervalId: null, // ë™ê¸°í™” ì¸í„°ë²Œ ID
            unsubscribes: [],
        };

        const ANIMAL_TYPES = [
            { 
                id: 'rabbit', 
                name: 'ì†œì‚¬íƒ• í† ë¼', 
                emoji: 'ğŸ°', 
                color: 'bg-pink-100', 
                text: 'text-pink-600', 
                desc: 'ë‹¤ì •í•˜ê³  ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ì¹œêµ¬',
                stages: [
                    { level: 0, emoji: 'ğŸ¥š', image: null, message: "í¬ê·¼í•œ ì´ë¶ˆ ì† ê°™ì•„ìš”... (Zzz)" },
                    { 
                        level: 1, 
                        emoji: 'ğŸ°', 
                        image: "https://i.imgur.com/F4zPjl6.png", 
                        message: "ê¹¡ì´! ì„¸ìƒì€ ë°˜ì§ë°˜ì§í•˜ë„¤ìš”! ë°˜ê°€ì›Œìš”!" 
                    }, 
                    { level: 2, emoji: 'ğŸ‡', image: null, message: "ë‹¹ê·¼ ì»µì¼€ì´í¬ ì£¼ì„¸ìš”! ì˜¤ëŠ˜ë„ í˜ë‚¼ê²Œìš”!" }, 
                    { level: 3, emoji: 'ğŸ’–', image: null, message: "ê·€ë¥¼ ì«‘ê¸‹ ì„¸ìš°ê³  ë„¤ ì´ì•¼ê¸°ë¥¼ ë“£ê³  ìˆì–´." }, 
                    { 
                        level: 4, 
                        emoji: 'ğŸ‘‘', 
                        image: "https://cdn-icons-png.flaticon.com/512/3069/3069172.png", 
                        message: "ìš°ë¦¬ëŠ” í™˜ìƒì˜ ì§ê¿ì´ì•¼! ë¬´ì—‡ì´ë“  í•  ìˆ˜ ìˆì–´!" 
                    }, 
                ]
            },
            { 
                id: 'bear', name: 'í¬ê·¼í•œ ê³°ëŒì´', emoji: 'ğŸ»', color: 'bg-amber-100', text: 'text-amber-700', desc: 'ë“¬ì§í•˜ê³  ë”°ëœ»í•œ ì¹œêµ¬',
                stages: [
                    { level: 0, emoji: 'ğŸ¥š', image: null, message: "ì¿¨... ì¿¨... ë”°ëœ»í•´ì„œ ë‚˜ê°€ê¸° ì‹«ì–´..." },
                    { level: 1, emoji: 'ğŸ§¸', image: null, message: "í•˜ì•”~ ì¼ì–´ë‚¬ì–´. ê·¼ë° ì¢€ ë°°ê³ í”„ë‹¤..." },
                    { level: 2, emoji: 'ğŸ»', image: null, message: "ì²œì²œíˆ ê°€ë„ ê´œì°®ì•„. ë‚´ê°€ ê³ì— ìˆì–ì•„." },
                    { level: 3, emoji: 'ğŸ¯', image: null, message: "ë„¤ê°€ ì—´ì‹¬íˆ í•˜ëŠ” ëª¨ìŠµ, ë‚´ê°€ ë¬µë¬µíˆ ì§€ì¼œë³´ê³  ìˆì–´." },
                    { level: 4, emoji: 'ğŸ”ï¸', image: null, message: "ì‚°ì²˜ëŸ¼ ë“ ë“ í•˜ê²Œ í‰ìƒ ë„ˆì˜ í¸ì´ ë˜ì–´ì¤„ê²Œ." },
                ]
            },
            { 
                id: 'cat', name: 'ë§ë‘ ëƒ¥ì´', emoji: 'ğŸ±', color: 'bg-blue-100', text: 'text-blue-600', desc: 'ê¹”ë”í•˜ê³  ë˜‘ë˜‘í•œ ì¹œêµ¬', 
                stages: [
                    { level: 0, emoji: 'ğŸ¥š', image: null, message: "ê±´ë“œë¦¬ì§€ ë§ˆ. ì•„ì§ ìëŠ” ì¤‘ì´ì•¼." },
                    { level: 1, emoji: 'ğŸˆ', image: null, message: "ì•¼ì˜¹. ë°¥ì€ ì±™ê²¨ ë¨¹ê³  ë‹¤ë‹ˆëŠ” ê±°ë‹ˆ?" },
                    { level: 2, emoji: 'ğŸ˜º', image: null, message: "ê·¸ë£¨ë°í•  ì‹œê°„ì´ì•¼. ê³µë¶€ë„ ì£¼ë³€ ì •ë¦¬ë¶€í„° ì‹œì‘í•´." },
                    { level: 3, emoji: 'ğŸ’', image: null, message: "í¥, ë”±íˆ ë„ ê¸°ë‹¤ë¦° ê±´ ì•„ë‹ˆì•¼. (ê¼¬ë¦¬ë¥¼ ì‚´ë‘ì´ë©°)" },
                    { level: 4, emoji: 'ğŸ‘‘', image: null, message: "ë„ˆì˜ ë…¸ë ¥, ê½¤ë‚˜ ìš°ì•„í•˜ê³  ë©‹ì§„ê±¸? ì¸ì •í•´ ì¤„ê²Œ." },
                ]
            },
            { 
                id: 'dog', name: 'ë°œë„ ê°•ì•„ì§€', emoji: 'ğŸ¶', color: 'bg-orange-100', text: 'text-orange-600', desc: 'í™œê¸°ì°¨ê³  ëª…ë‘í•œ ì¹œêµ¬', 
                stages: [
                    { level: 0, emoji: 'ğŸ¥š', image: null, message: "í‚í‚! ë°–ì—ì„œ ë§›ìˆëŠ” ëƒ„ìƒˆê°€ ë‚˜ìš”!" },
                    { level: 1, emoji: 'ğŸ•', image: null, message: "ë©ë©! ê¼¬ë¦¬ê°€ ë©ˆì¶”ì§ˆ ì•Šì•„ìš”! ì§„ì§œ ë°˜ê°€ì›Œìš”!" },
                    { level: 2, emoji: 'ğŸ¦´', image: null, message: "ì‚°ì±… ê°ˆê¹Œìš”? ê³µë†€ì´ í• ê¹Œìš”? ê³µë¶€ë„ ê°™ì´ í•´ìš”!" },
                    { level: 3, emoji: 'ğŸ¾', image: null, message: "ë„¤ê°€ ì›ƒìœ¼ë©´ ë‚˜ë„ í–‰ë³µí•´! ì™ˆì™ˆ! í˜ë‚´ì!" },
                    { level: 4, emoji: 'ğŸ†', image: null, message: "ì–¸ì œë‚˜ ë„¤ í¸ì´ì•¼! ìš°ë¦° ìµœê³ ì˜ íŒŒíŠ¸ë„ˆê°€ ë  ê±°ì•¼!" },
                ]
            },
            { 
                id: 'hamster', name: 'ë³¼ë¹µë¹µ í–„ì°Œ', emoji: 'ğŸ¹', color: 'bg-yellow-100', text: 'text-yellow-700', desc: 'ë¶€ì§€ëŸ°í•˜ê³  ê·€ì—¬ìš´ ì¹œêµ¬',
                stages: [
                    { level: 0, emoji: 'ğŸ¥š', image: null, message: "ë°”ìŠ¤ë½... ë°”ìŠ¤ë½... (ë­”ê°€ ê°‰ì•„ë¨¹ëŠ” ì†Œë¦¬)" },
                    { level: 1, emoji: 'ğŸ', image: null, message: "ì°! í•´ë°”ë¼ê¸° ì”¨ í•˜ë‚˜ë§Œ ì£¼ë©´ ì•ˆ ì¡ì•„ë¨¹ì§€!" },
                    { level: 2, emoji: 'ğŸŒ°', image: null, message: "ë³¼ì£¼ë¨¸ë‹ˆê°€ ë¹µë¹µí•´ì•¼ ë§ˆìŒì´ í¸í•´. ë„ˆë„ ê°„ì‹ ë¨¹ê³  í•´." },
                    { level: 3, emoji: 'ğŸƒâ€â™‚ï¸', image: null, message: "ì˜¤ëŠ˜ë„ ì³‡ë°”í€´ì²˜ëŸ¼ ë¶€ì§€ëŸ°íˆ! ì˜ì°¨ì˜ì°¨! ë©ˆì¶”ì§€ ë§ˆ!" },
                    { level: 4, emoji: 'ğŸ…', image: null, message: "ì‘ì§€ë§Œ ê°•í•œ ë‚˜ë¥¼ ë´! ê¾¸ì¤€í•¨ì´ ë„ˆì˜ ë¬´ê¸°ê°€ ë  ê±°ì•¼!" },
                ]
            },
            // í˜¸ê¸°ì‹¬ ë„ˆêµ¬ë¦¬ë¡œ ë³€ê²½ë¨
            { 
                id: 'raccoon', name: 'í˜¸ê¸°ì‹¬ ë„ˆêµ¬ë¦¬', emoji: 'ğŸ¦', color: 'bg-teal-100', text: 'text-teal-700', desc: 'ê¶ê¸ˆí•œ ê²Œ ë§ì€ ì¥ë‚œê¾¸ëŸ¬ê¸°',
                stages: [
                    { level: 0, emoji: 'ğŸ¥š', image: null, message: "ì½œë¡ì½œë¡... ì™œ ì´ë ‡ê²Œ í‚í‚ê±°ë¦¬ì§€?" },
                    { level: 1, emoji: 'ğŸ¦', image: null, message: "ì•ˆë…•! ë„¤ ì£¼ë¨¸ë‹ˆì— ë­ê°€ ë“¤ì–´ìˆëŠ”ì§€ ê¶ê¸ˆí•´!" },
                    { level: 2, emoji: 'ğŸ¾', image: null, message: "ì—¬ê¸°ì €ê¸° ë‹¤ íƒí—˜í•´ ë³¼ ê±°ì•¼! ë„ˆë„ ê°™ì´ ê°€ì!" },
                    { level: 3, emoji: 'ğŸ”', image: null, message: "ì„¸ìƒì€ í¼ì¦ ê°™ì•„! ê°™ì´ ë§ì¶°ë³¼ê¹Œ?" },
                    { level: 4, emoji: 'ğŸ—ºï¸', image: null, message: "ë‚˜ì˜ í° ê³„íšì€ ì„¸ê³„ ì •ë³µ... ì•„ë‹ˆ, ì„¸ìƒì„ ë°°ìš°ëŠ” ê±°ì•¼!" },
                ]
            },
        ];

        const STAGES = [
            { level: 0, name: 'ì‹ ë¹„í•œ ì•Œ' }, 
            { level: 1, name: 'ì•„ê¸° ë™ë¬¼' },
            { level: 2, name: 'ì–´ë¦°ì´ ë™ë¬¼' },
            { level: 3, name: 'ì²­ì†Œë…„ ë™ë¬¼' },
            { level: 4, name: 'ì–´ë¥¸ ë™ë¬¼' },
        ];

        const MOODS = [
            { mood: 'happy', emoji: 'ğŸ˜Š', label: 'ì‹ ë‚˜ìš”!', color: 'bg-green-500', response: (name) => `${name}ì´ê°€ í–‰ë³µí•˜ë‹¤ë‹ˆ ë‚˜ë„ ë„ˆë¬´ ê¸°ë»! ì´ ê¸°ë¶„ ê·¸ëŒ€ë¡œ í•˜ë£¨ë¥¼ ì¦ê²¨ë³´ì!`, icon: 'ğŸ‰' },
            { mood: 'tired', emoji: 'ğŸ˜´', label: 'í”¼ê³¤í•´ìš”', color: 'bg-indigo-500', response: (name) => `${name}ì•„, ë§ì´ í”¼ê³¤í–ˆêµ¬ë‚˜. ì ê¹ ëˆˆì„ ê°ê³  ì‹¬í˜¸í¡í•´ë³´ì. ì¡°ê¸ˆ ì‰¬ì–´ë„ ê´œì°®ì•„.`, icon: 'â˜•' },
            { mood: 'sad', emoji: 'ğŸ˜¢', label: 'ìŠ¬í¼ìš”', color: 'bg-blue-500', response: (name) => `${name}ì´ê°€ ìŠ¬í¼í•˜ëŠ” ëª¨ìŠµì„ ë³´ë‹ˆ ë§ˆìŒì´ ì•„íŒŒ. ë„¤ ì˜†ì— ë‚´ê°€ ìˆìœ¼ë‹ˆ ë„ˆë¬´ ê±±ì • ë§ˆ. í˜ë‚´ì!`, icon: 'ğŸ«‚' },
            { mood: 'angry', emoji: 'ğŸ˜¡', label: 'í™”ë‚˜ìš”', color: 'bg-red-500', response: (name) => `${name}ì•„, í™”ê°€ ë‚  ë• ì ì‹œ ë©ˆì¶°ë³´ì. ë§›ìˆëŠ” ì¿ í‚¤ë¥¼ ë¨¹ê³  ê¸°ë¶„ ì „í™˜í•˜ëŠ” ê±´ ì–´ë•Œ?`, icon: 'ğŸ’¥' },
            { mood: 'excited', emoji: 'ğŸ¥³', label: 'ë„ˆë¬´ ì‹ ë‚˜ìš”', color: 'bg-yellow-500', response: (name) => `ì™€! ${name}ì´ê°€ ì‹ ë‚˜ ë³´ì´ëŠ”ê±¸! ë¬´ìŠ¨ ì¢‹ì€ ì¼ ìˆì–´? ë„¤ í™œê¸°ì°¬ ëª¨ìŠµì´ ë‚˜ì—ê²Œ í˜ì„ ì¤˜!`, icon: 'ğŸˆ' },
            { mood: 'calm', emoji: 'ğŸ˜Œ', label: 'í‰ì˜¨í•´ìš”', color: 'bg-slate-500', response: (name) => `${name}ì•„, í‰ì˜¨í•œ ê¸°ë¶„ ì •ë§ ì¢‹ë‹¤! ì´ í‰í™”ë¡œìš´ ê¸°ìš´ì„ ëª¨ë‘ì™€ ë‚˜ëˆ ë³´ì.`, icon: 'ğŸ§˜' },
        ];

        const TEST_QUESTIONS = [
            {
                q: "ì‰¬ëŠ” ì‹œê°„ì— ë‚˜ëŠ”?",
                a: [{ text: "ì¹œêµ¬ë“¤ê³¼ ì‹ ë‚˜ê²Œ ë›°ì–´ë…¼ë‹¤", type: [3, 5] }, { text: "ìë¦¬ì— ì•‰ì•„ ì¡°ìš©íˆ ì‰°ë‹¤", type: [0, 2] }]
            },
            {
                q: "ìˆ™ì œê°€ ì–´ë ¤ìš¸ ë•Œ ë‚˜ëŠ”?",
                a: [{ text: "ëê¹Œì§€ í˜¼ì í•´ê²°í•´ë³¸ë‹¤", type: [1, 4] }, { text: "ì¹œêµ¬ë‚˜ ì„ ìƒë‹˜ê»˜ ë¬¼ì–´ë³¸ë‹¤", type: [0, 3] }]
            },
            {
                q: "ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ê°„ì‹ì€?",
                a: [{ text: "ë‹¬ì½¤í•œ ì´ˆì½œë¦¿/ì‚¬íƒ•", type: [0, 5] }, { text: "ë°”ì‚­í•œ ê³¼ì/ë¹µ", type: [1, 2, 4] }]
            }
        ];

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        const setState = (newState) => {
            Object.assign(globalState, newState);
            render();
        };

        const getCurrentStageInfo = (pet, level, petName) => {
            if (!pet) return null;
            const stage = pet.stages ? pet.stages[level] : null;

            const defaultInfo = {
                emoji: pet.emoji,
                image: null,
                message: `${petName || pet.name}ì´(ê°€) ì„±ì¥í–ˆì–´ìš”!`,
            };

            return stage || defaultInfo;
        };

        const getCurrentPetLevel = (cookies, thresholds) => {
            let currentLevel = 0;
            const thres = thresholds;
            if (thres && thres.length > 0) {
                for (let i = thres.length - 1; i >= 0; i--) {
                    if (cookies >= (parseInt(thres[i]) || 0)) {
                        currentLevel = i;
                        break;
                    }
                }
            }
            return currentLevel;
        };

        const formatIcon = (name, classes) => {
            // CRITICAL FIX: window.lucide ê°ì²´ì˜ ì¡´ì¬ ì—¬ë¶€ì™€ iconFnì´ ì‹¤ì œë¡œ í•¨ìˆ˜ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
            const iconFn = window.lucide ? window.lucide[name] : null;
            if (typeof iconFn !== 'function') return '';
            
            // Lucide ì•„ì´ì½˜ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ SVG ë¬¸ìì—´ì„ ìƒì„±í•©ë‹ˆë‹¤.
            // ì¸ìë¡œëŠ” ì•„ì´ì½˜ ì†ì„±ì„ ì „ë‹¬í•©ë‹ˆë‹¤.
            return iconFn({ class: classes, width: 24, height: 24 });
        };
        
        // --- ê¸°ëŠ¥ í•¨ìˆ˜ ---
        const fetchCookieData = async (key, code) => {
            if (!key || !code) return;
            if (globalState.view === 'intro') setState({ loading: true });

            try {
                const url = `https://api.dahandin.com/openapi/v1/get/student/total?code=${code}`;
                
                // ì§€ìˆ˜ ë°±ì˜¤í”„ ë¡œì§
                let response = null;
                let json = null;
                let maxRetries = 3;
                let delay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'X-API-Key': key,
                                'Content-Type': 'application/json'
                            }
                        });
                        json = await response.json();
                        
                        if (json.result) {
                            break; // ì„±ê³µ ì‹œ ë£¨í”„ íƒˆì¶œ
                        } else if (i === maxRetries - 1) {
                             console.warn("API í˜¸ì¶œ ì‹¤íŒ¨:", json.message);
                             // ë§ˆì§€ë§‰ ì‹œë„ ì‹¤íŒ¨ ì‹œ ê²½ê³ 
                             if(globalState.view === 'intro') {
                                 const appElement = document.getElementById('app');
                                 appElement.insertAdjacentHTML('beforeend', createAlertModal(`ì˜¤ë¥˜: ${json.message}`));
                             }
                        }
                    } catch (error) {
                        if (i === maxRetries - 1) {
                            console.error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
                        }
                    }
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // ì§€ìˆ˜ ë°±ì˜¤í”„
                    }
                }
                
                if (json && json.result && json.data && typeof json.data.cookie === 'number') {
                    const newLevel = getCurrentPetLevel(json.data.cookie, globalState.globalSettings.thresholds);
                    setState({ cookies: json.data.cookie, petLevel: newLevel });
                }
                
            } catch (error) {
                console.error("ë„¤íŠ¸ì›Œí¬ ìµœì¢… ì˜¤ë¥˜:", error);
            } finally {
                setState({ loading: false });
            }
        };

        const startSync = (key, code) => {
            if (globalState.syncIntervalId) clearInterval(globalState.syncIntervalId);

            const intervalId = setInterval(() => {
                fetchCookieData(key, code);
            }, 60000); 
            
            setState({ syncIntervalId: intervalId });
        };
        
        const stopSync = () => {
            if (globalState.syncIntervalId) clearInterval(globalState.syncIntervalId);
            setState({ syncIntervalId: null });
        };

        const handleStudentLogin = async () => {
            if (!globalState.globalSettings.apiKey) {
                const appElement = document.getElementById('app');
                appElement.insertAdjacentHTML('beforeend', createAlertModal("ì„ ìƒë‹˜ ì„¤ì •ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."));
                return;
            }
            const code = globalState.studentCode.trim();
            if (code.length === 0) {
                const appElement = document.getElementById('app');
                appElement.insertAdjacentHTML('beforeend', createAlertModal("í•™ìƒ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!"));
                return;
            }

            // ì´ˆê¸° ì¿ í‚¤ ë°ì´í„° fetch
            await fetchCookieData(globalState.globalSettings.apiKey, code);
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í« ì •ë³´ + ì´ë¦„ ë¡œë“œ
            const storageKey = `pet_data_${code}`;
            const savedDataStr = localStorage.getItem(storageKey);
            let nextView = 'test';
            let pet = null;
            let petName = '';
            
            if (savedDataStr) {
                try {
                    const savedData = JSON.parse(savedDataStr);
                    if (savedData.typeId) {
                        pet = ANIMAL_TYPES.find(a => a.id === savedData.typeId);
                        petName = savedData.name || pet?.name || '';
                    }
                } catch (e) {
                    console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜", e);
                }
            } else {
                 // êµ¬ë²„ì „ í‚¤ ì²´í¬ (pet_{studentCode})
                const oldKey = `pet_${code}`;
                const oldSavedId = localStorage.getItem(oldKey);
                if (oldSavedId) {
                    pet = ANIMAL_TYPES.find(a => a.id === oldSavedId);
                    if (pet) {
                        petName = pet.name;
                    }
                }
            }
            
            if (pet) {
                nextView = 'main';
                setState({ myPet: pet, petName: petName, view: nextView });
                startSync(globalState.globalSettings.apiKey, code);
                setTimeout(sayGoodWord, 100);
            } else {
                setState({ view: nextView });
            }
        };

        const sayGoodWord = () => {
            const currentStageInfo = getCurrentStageInfo(globalState.myPet, globalState.petLevel, globalState.petName);
            if (currentStageInfo) {
                setState({ message: currentStageInfo.message });
            } else {
                setState({ message: `${globalState.petName || globalState.myPet?.name}ì´(ê°€) í˜ì„ ë‚¼ê²Œìš”!` });
            }
        };
        
        const handleAdminSave = async () => {
            if (!globalState.user) return;
            const newThresholds = globalState.adminThresholdsInput.map(t => Math.max(0, parseInt(t) || 0));
            try {
                const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings');
                await setDoc(configRef, {
                    apiKey: globalState.adminApiKeyInput,
                    thresholds: newThresholds
                });
                
                const appElement = document.getElementById('app');
                appElement.insertAdjacentHTML('beforeend', createAlertModal("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"));
                
                setState({ 
                    showAdminSettings: false,
                    globalSettings: {
                        apiKey: globalState.adminApiKeyInput,
                        thresholds: newThresholds
                    }
                });
            } catch (e) {
                console.error("ì €ì¥ ì‹¤íŒ¨:", e);
                const appElement = document.getElementById('app');
                appElement.insertAdjacentHTML('beforeend', createAlertModal("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
            }
        };

        const checkAdminPassword = () => {
            if (globalState.adminPasswordInput === "0215") {
                setState({ showAdminLogin: false, showAdminSettings: true, adminPasswordInput: '' });
            } else {
                const appElement = document.getElementById('app');
                appElement.insertAdjacentHTML('beforeend', createAlertModal("ì•”í˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."));
                setState({ adminPasswordInput: '' });
            }
        };

        const handleAnswer = (types) => {
            const newScores = { ...globalState.testScores };
            types.forEach(t => newScores[t] += 1);
            setState({ testScores: newScores });

            if (globalState.testStep < TEST_QUESTIONS.length - 1) {
                setState({ testStep: globalState.testStep + 1 });
            } else {
                let maxScore = -1;
                let candidates = [];
                Object.keys(newScores).forEach(key => {
                    if (newScores[key] > maxScore) {
                        maxScore = newScores[key];
                        candidates = [parseInt(key)];
                    } else if (newScores[key] === maxScore) {
                        candidates.push(parseInt(key));
                    }
                });
                const finalIndex = candidates[Math.floor(Math.random() * candidates.length)];
                const selectedPet = ANIMAL_TYPES[finalIndex];
                
                setState({ 
                    myPet: selectedPet, 
                    inputName: selectedPet.name,
                    view: 'naming', 
                    testScores: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }
                });
            }
        };

        const handleNamingComplete = () => {
            if (globalState.inputName.trim().length === 0) {
                const appElement = document.getElementById('app');
                appElement.insertAdjacentHTML('beforeend', createAlertModal("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"));
                return;
            }
            const finalName = globalState.inputName.trim();
            
            // ì €ì¥ (ID + ì´ë¦„)
            const storageKey = `pet_data_${globalState.studentCode}`;
            const dataToSave = {
                typeId: globalState.myPet.id,
                name: finalName
            };
            localStorage.setItem(storageKey, JSON.stringify(dataToSave));

            setState({ 
                petName: finalName, 
                view: 'main' 
            });
            startSync(globalState.globalSettings.apiKey, globalState.studentCode);
            setTimeout(() => {
                const currentStageInfo = getCurrentStageInfo(globalState.myPet, globalState.petLevel, finalName);
                if (currentStageInfo) {
                    setState({ message: currentStageInfo.message });
                } else {
                    setState({ message: "ë§Œë‚˜ì„œ ë°˜ê°€ì›Œ!" });
                }
            }, 100);
        };
        
        const handleMoodSelection = (moodObject) => {
            const displayName = globalState.petName || globalState.myPet?.name || '';
            const responseText = moodObject.response(displayName);
            setState({ message: responseText, showMoodCheck: false });
        };

        // --- ë Œë”ë§ í•¨ìˆ˜ ---
        const renderIntro = () => {
            const { loading, studentCode, showAdminLogin, showAdminSettings, adminPasswordInput, adminApiKeyInput, adminThresholdsInput } = globalState;
            
            const adminLoginModal = showAdminLogin ? `
                <div class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center animate-fade-in">
                        <div class="flex justify-center mb-4 text-slate-400">
                            ${formatIcon('Lock', 'w-8 h-8')}
                        </div>
                        <h3 class="font-bold text-lg text-slate-700 mb-2">ì„ ìƒë‹˜ í™•ì¸</h3>
                        <input 
                            type="password" 
                            id="adminPasswordInput"
                            placeholder="ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                            value="${adminPasswordInput}"
                            onchange="globalState.adminPasswordInput = this.value; render();"
                            class="w-full p-3 border rounded-xl mb-4 focus:outline-sky-500"
                        />
                        <div class="flex gap-2">
                            <button 
                                onclick="setState({ showAdminLogin: false, adminPasswordInput: '' })"
                                class="flex-1 py-3 text-slate-500 font-bold bg-slate-100 rounded-xl"
                            >
                                ì·¨ì†Œ
                            </button>
                            <button 
                                onclick="checkAdminPassword()"
                                class="flex-1 py-3 text-white font-bold bg-sky-500 rounded-xl"
                            >
                                í™•ì¸
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';

            const adminSettingsModal = showAdminSettings ? `
                <div class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm h-3/4 overflow-y-auto">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg flex items-center gap-2">
                                ${formatIcon('Settings', 'w-5 h-5')} ë°˜ ì„¤ì •
                            </h3>
                            <button onclick="setState({ showAdminSettings: false })" class="text-slate-400 hover:text-slate-600">âœ•</button>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="text-sm font-bold text-slate-700 block mb-1">
                                    ë‹¤í–ˆë‹ˆ X-API-Key
                                </label>
                                <input 
                                    type="text"
                                    value="${adminApiKeyInput}" 
                                    onchange="globalState.adminApiKeyInput = this.value; render();"
                                    placeholder="API Key ë¶™ì—¬ë„£ê¸°"
                                    class="w-full p-3 border rounded-lg focus:outline-sky-500 text-sm bg-slate-50"
                                />
                            </div>

                            <div>
                                <label class="text-sm font-bold text-slate-700 block mb-2">
                                    ì„±ì¥ë³„ í•„ìš” ì¿ í‚¤ ìˆ˜
                                </label>
                                ${STAGES.map((stage, idx) => `
                                    <div key="${idx}" class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-slate-600 w-24">${stage.name}</span>
                                        <div class="flex items-center gap-2">
                                            <input 
                                                type="number" 
                                                value="${adminThresholdsInput[idx]}" 
                                                onchange="globalState.adminThresholdsInput[${idx}] = this.value; render();"
                                                ${idx === 0 ? 'disabled' : ''} 
                                                class="w-20 p-2 border rounded-lg text-right focus:outline-sky-500 text-sm"
                                            />
                                            <span class="text-xs text-slate-400">ê°œ ì´ìƒ</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="mt-6 pt-4 border-t flex gap-2">
                            <button 
                                onclick="setState({ showAdminSettings: false })"
                                class="flex-1 py-3 text-slate-500 font-bold bg-slate-100 rounded-xl"
                            >
                                ì·¨ì†Œ
                            </button>
                            <button 
                                onclick="handleAdminSave()"
                                class="flex-1 py-3 bg-sky-500 text-white rounded-xl font-bold hover:bg-sky-600 flex items-center justify-center gap-2"
                            >
                                ${formatIcon('Save', 'w-4 h-4')} ì €ì¥í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';

            return `
                <div class="min-h-screen bg-sky-50 flex flex-col items-center justify-center p-4 font-sans relative">
                    <div class="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center border-4 border-sky-100 z-10">
                        <div class="flex justify-center mb-6">
                            <div class="bg-sky-100 p-4 rounded-full">
                                ${formatIcon('Sparkles', 'w-12 h-12 text-sky-500')}
                            </div>
                        </div>
                        <h1 class="text-3xl font-bold text-slate-700 mb-2">ë‚˜ë§Œì˜ ì¿ í‚¤ í«</h1>
                        <p class="text-slate-500 mb-6">í•™ìƒ ì½”ë“œë¥¼ ì…ë ¥í•˜ê³  ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                        
                        <div class="mb-6 text-left">
                            <label class="text-xs font-bold text-slate-500 ml-1">í•™ìƒ ì½”ë“œ</label>
                            <div class="relative">
                                ${formatIcon('User', 'absolute left-3 top-3.5 w-4 h-4 text-slate-400')}
                                <input
                                    type="text"
                                    placeholder="ì˜ˆ: STU12345"
                                    class="w-full pl-10 p-3 bg-slate-50 rounded-xl border-2 border-slate-200 focus:outline-none focus:border-sky-400 transition-colors"
                                    value="${studentCode}"
                                    oninput="globalState.studentCode = this.value; render();"
                                />
                            </div>
                        </div>

                        <button 
                            onclick="handleStudentLogin()"
                            ${loading ? 'disabled' : ''}
                            class="w-full bg-sky-400 hover:bg-sky-500 text-white font-bold py-4 rounded-xl transition-all shadow-md active:scale-95 disabled:opacity-50 mb-4"
                        >
                            ${loading ? 'í«ì„ ì°¾ëŠ” ì¤‘...' : 'ì‹œì‘í•˜ê¸°'}
                        </button>

                        <button 
                            onclick="setState({ showAdminLogin: true })"
                            class="text-xs text-slate-400 underline hover:text-slate-600 p-2"
                        >
                            ì„ ìƒë‹˜ ì„¤ì • (API í‚¤ ì…ë ¥)
                        </button>
                    </div>

                    ${adminLoginModal}
                    ${adminSettingsModal}
                </div>
            `;
        };

        const renderTest = () => {
            const { testStep } = globalState;
            const currentQuestion = TEST_QUESTIONS[testStep];

            return `
                <div class="min-h-screen bg-purple-50 flex flex-col items-center justify-center p-4">
                    <div class="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full border-4 border-purple-100 animate-fade-in">
                        <div class="mb-6 flex justify-between text-purple-400 font-bold">
                            <span>ë‚˜ì˜ í« ì°¾ê¸°</span>
                            <span>${testStep + 1} / ${TEST_QUESTIONS.length}</span>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-700 mb-8 leading-snug">
                            ${currentQuestion.q}
                        </h2>
                        <div class="space-y-4">
                            ${currentQuestion.a.map((ans, idx) => `
                                <button
                                    key="${idx}"
                                    onclick="handleAnswer([${ans.type.join(',')}])"
                                    class="w-full p-5 text-left bg-purple-50 hover:bg-purple-100 text-purple-900 rounded-xl font-medium transition-colors border-2 border-transparent hover:border-purple-200"
                                >
                                    ${ans.text}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderNaming = () => {
            const { myPet, inputName } = globalState;
            return `
                <div class="min-h-screen ${myPet.color} flex flex-col items-center justify-center p-4">
                    <div class="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center border-4 border-white/50 animate-fade-in">
                        <div class="text-6xl mb-6">${myPet.emoji}</div>
                        <h2 class="text-2xl font-bold text-slate-700 mb-2">
                            ë‹¹ì‹ ì˜ í«ì€ <span class="${myPet.text}">${myPet.name}</span>ì…ë‹ˆë‹¤!
                        </h2>
                        <p class="text-slate-500 mb-6">í«ì—ê²Œ íŠ¹ë³„í•œ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”.</p>
                        
                        <input
                            type="text"
                            placeholder="ì´ë¦„ ì…ë ¥"
                            class="w-full p-4 bg-slate-50 rounded-xl border-2 border-slate-200 mb-4 focus:outline-none focus:border-sky-400 text-center text-lg font-bold text-slate-700"
                            value="${inputName}"
                            oninput="globalState.inputName = this.value; render();"
                            maxlength="10"
                        />
                        <button 
                            onclick="handleNamingComplete()"
                            class="w-full bg-sky-400 hover:bg-sky-500 text-white font-bold py-4 rounded-xl transition-all shadow-md active:scale-95"
                        >
                            ì´ ì´ë¦„ìœ¼ë¡œ í‚¤ìš°ê¸°
                        </button>
                    </div>
                </div>
            `;
        };
        
        const renderMain = () => {
            const { cookies, myPet, petName, petLevel, message, showMoodCheck, showAdminLogin, showAdminSettings, adminPasswordInput, adminApiKeyInput, adminThresholdsInput, imageError } = globalState;

            if (!myPet) return `<div class="p-8 text-center">í« ì •ë³´ ë¡œë”© ì¤‘...</div>`;

            const currentStageInfo = getCurrentStageInfo(myPet, petLevel, petName);
            const nextLevelThreshold = globalState.globalSettings.thresholds[petLevel + 1] || 0;
            const currentLevelThreshold = globalState.globalSettings.thresholds[petLevel] || 0;
            const progressRange = nextLevelThreshold - currentLevelThreshold;
            const progressValue = cookies - currentLevelThreshold;
            const progressPercent = progressRange > 0 ? Math.min(100, (progressValue / progressRange) * 100) : 0;
            
            const adminLoginModal = showAdminLogin ? `
                <div class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center animate-fade-in">
                        <div class="flex justify-center mb-4 text-slate-400">
                            ${formatIcon('Lock', 'w-8 h-8')}
                        </div>
                        <h3 class="font-bold text-lg text-slate-700 mb-2">ì„ ìƒë‹˜ í™•ì¸</h3>
                        <input 
                            type="password" 
                            placeholder="ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                            value="${adminPasswordInput}"
                            onchange="globalState.adminPasswordInput = this.value; render();"
                            class="w-full p-3 border rounded-xl mb-4 focus:outline-sky-500"
                        />
                        <div class="flex gap-2">
                            <button 
                                onclick="setState({ showAdminLogin: false, adminPasswordInput: '' })"
                                class="flex-1 py-3 text-slate-500 font-bold bg-slate-100 rounded-xl"
                            >
                                ì·¨ì†Œ
                            </button>
                            <button 
                                onclick="checkAdminPassword()"
                                class="flex-1 py-3 text-white font-bold bg-sky-500 rounded-xl"
                            >
                                í™•ì¸
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';

            const adminSettingsModal = showAdminSettings ? `
                <div class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm h-3/4 overflow-y-auto">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg flex items-center gap-2">
                                ${formatIcon('Settings', 'w-5 h-5')} ë°˜ ì„¤ì •
                            </h3>
                            <button onclick="setState({ showAdminSettings: false })" class="text-slate-400 hover:text-slate-600">âœ•</button>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="text-sm font-bold text-slate-700 block mb-1">ë‹¤í–ˆë‹ˆ X-API-Key</label>
                                <input 
                                    type="text"
                                    value="${adminApiKeyInput}" 
                                    onchange="globalState.adminApiKeyInput = this.value; render();"
                                    placeholder="API Key ë¶™ì—¬ë„£ê¸°"
                                    class="w-full p-3 border rounded-lg focus:outline-sky-500 text-sm bg-slate-50"
                                />
                            </div>

                            <div>
                                <label class="text-sm font-bold text-slate-700 block mb-2">ì„±ì¥ë³„ í•„ìš” ì¿ í‚¤ ìˆ˜</label>
                                ${STAGES.map((stage, idx) => `
                                    <div key="${idx}" class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-slate-600 w-24">${stage.name}</span>
                                        <div class="flex items-center gap-2">
                                            <input 
                                                type="number" 
                                                value="${adminThresholdsInput[idx]}" 
                                                onchange="globalState.adminThresholdsInput[${idx}] = this.value; render();"
                                                ${idx === 0 ? 'disabled' : ''} 
                                                class="w-20 p-2 border rounded-lg text-right focus:outline-sky-500 text-sm"
                                            />
                                            <span class="text-xs text-slate-400">ê°œ ì´ìƒ</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="mt-6 pt-4 border-t flex gap-2">
                            <button 
                                onclick="setState({ showAdminSettings: false })"
                                class="flex-1 py-3 text-slate-500 font-bold bg-slate-100 rounded-xl"
                            >
                                ì·¨ì†Œ
                            </button>
                            <button 
                                onclick="handleAdminSave()"
                                class="flex-1 py-3 bg-sky-500 text-white rounded-xl font-bold hover:bg-sky-600 flex items-center justify-center gap-2"
                            >
                                ${formatIcon('Save', 'w-4 h-4')} ì €ì¥í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';
            
            const moodCheckModal = showMoodCheck ? `
                <div class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-md animate-fade-in text-center">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-xl text-slate-700 flex items-center gap-2">
                                ${formatIcon('MessageSquare', 'w-6 h-6 text-purple-500')} ${petName || myPet.name}ì˜ ê¸°ë¶„ ì²´í¬ì¸
                            </h3>
                            <button onclick="setState({ showMoodCheck: false })" class="text-slate-400 hover:text-slate-600">âœ•</button>
                        </div>
                        <p class="text-slate-600 text-lg mb-6">${petName || myPet.name}ì—ê²Œ ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì„ ê³µìœ í•´ ì¤˜!</p>
                        
                        <div class="grid grid-cols-3 gap-4">
                            ${MOODS.map((moodObj) => `
                                <button
                                    key="${moodObj.mood}"
                                    onclick="handleMoodSelection({ mood: '${moodObj.mood}', response: (name) => '${moodObj.response(petName || myPet.name)}', icon: '${moodObj.icon}' })"
                                    class="flex flex-col items-center justify-center p-4 rounded-xl text-white font-bold transition-all shadow-md hover:shadow-lg active:scale-95 ${moodObj.color}"
                                >
                                    <span class="text-4xl">${moodObj.icon}</span>
                                    <span class="mt-2 text-sm">${moodObj.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : '';

            const petImageContent = currentStageInfo.image && !imageError ? 
                `<img 
                    src="${currentStageInfo.image}" 
                    alt="${myPet.name}" 
                    class="w-64 h-64 object-contain" 
                    onerror="globalState.imageError = true; render();" 
                />` : 
                `<span class="text-9xl select-none">${currentStageInfo.emoji}</span>`;

            return `
                <div class="min-h-screen transition-colors duration-500 ${myPet.color} flex flex-col items-center relative overflow-hidden">
                    
                    <button 
                        onclick="setState({ showAdminLogin: true, adminPasswordInput: '', adminApiKeyInput: globalState.globalSettings.apiKey, adminThresholdsInput: globalState.globalSettings.thresholds })"
                        class="absolute top-4 right-4 p-2 bg-white/50 rounded-full hover:bg-white transition-colors z-50 shadow-sm"
                        aria-label="ê´€ë¦¬ì ì„¤ì •"
                    >
                        ${formatIcon('Settings', 'w-6 h-6 text-slate-600')}
                    </button>

                    <!-- í—¤ë” ì •ë³´ -->
                    <div class="w-full max-w-md mt-10 px-6 flex justify-between items-center z-10">
                        <div class="bg-white/80 backdrop-blur-sm px-4 py-2 rounded-2xl shadow-sm border border-white/50">
                            <span class="text-xs text-slate-500 block">í˜„ì¬ ë‹¨ê³„</span>
                            <span class="font-bold text-slate-700">${STAGES[petLevel].name}</span>
                        </div>
                        <div class="bg-white/80 backdrop-blur-sm px-4 py-2 rounded-2xl shadow-sm border border-white/50 flex items-center gap-2">
                            <span class="text-amber-500">ğŸª</span>
                            <span class="font-bold text-slate-700 text-lg">${cookies}ê°œ</span>
                        </div>
                    </div>

                    <!-- í« í‘œì‹œ ì˜ì—­ -->
                    <div class="flex-1 flex flex-col items-center justify-center w-full max-w-md relative z-10">
                        <div 
                            class="mb-8 px-6 py-4 bg-white rounded-t-3xl rounded-br-3xl rounded-bl-none shadow-lg transform transition-all duration-300 ${message ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'}"
                            style="min-height: 80px; min-width: 200px; max-width: 300px;"
                        >
                            <p class="text-slate-600 font-medium text-center break-keep leading-relaxed">
                                ${message || (currentStageInfo?.message || "ì•ˆë…•í•˜ì„¸ìš”!")}
                            </p>
                        </div>

                        <div 
                            onclick="sayGoodWord()"
                            class="cursor-pointer transition-transform active:scale-95 hover:-translate-y-2 duration-300"
                        >
                            <div class="relative flex justify-center items-center">
                                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-white/30 rounded-full blur-3xl -z-10"></div>
                                <div class="filter drop-shadow-xl animate-bounce-slow">
                                    ${petImageContent}
                                </div>
                            </div>
                        </div>

                        <!-- ì´ë¦„í‘œ (ì‚¬ìš©ì ì§€ì • ì´ë¦„) -->
                        <div class="mt-8 bg-white/60 backdrop-blur-md px-6 py-2 rounded-full shadow-sm flex items-center gap-2">
                            <h2 class="text-xl font-bold ${myPet.text}">
                                ${petLevel === 0 ? '???' : (petName || myPet.name)}
                            </h2>
                        </div>
                        
                        ${petLevel < 4 ? `
                            <div class="w-64 mt-6">
                                <div class="flex justify-between text-xs text-slate-500 mb-1">
                                    <span>ë‹¤ìŒ ë‹¨ê³„ê¹Œì§€</span>
                                    <span>${Math.max(0, nextLevelThreshold - cookies)} ì¿ í‚¤ ë‚¨ìŒ</span>
                                </div>
                                <div class="w-full bg-white/50 rounded-full h-3 overflow-hidden">
                                    <div 
                                        class="h-full rounded-full transition-all duration-1000 ${myPet.text.replace('text', 'bg')}"
                                        style="width: ${progressPercent}%" 
                                    ></div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="w-full bg-white/80 backdrop-blur-lg p-6 rounded-t-3xl shadow-negative-lg z-20">
                        <div class="max-w-md mx-auto space-y-3">
                            <button 
                                onclick="setState({ showMoodCheck: true })"
                                ${petLevel === 0 ? 'disabled' : ''}
                                class="w-full py-3 bg-purple-500 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2 disabled:opacity-50"
                            >
                                ${formatIcon('Smile', 'w-4 h-4')} ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì€?
                            </button>
                            
                            <div class="flex justify-between items-center mb-4 pt-2">
                                <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                    ${formatIcon('RefreshCw', 'w-4 h-4')} ë‹¤í–ˆë‹ˆ ë™ê¸°í™”
                                </h3>
                                <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">
                                    ìë™ (1ë¶„ ì£¼ê¸°)
                                
                                </span>
                            </div>
                            <button 
                                onclick="setState({ cookies: globalState.cookies + 1 }); if(globalState.petLevel > 0) setState({ message: 'ì™€! ì¿ í‚¤ê°€ ëŠ˜ì–´ë‚¬ì–´!' });"
                                class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2"
                            >
                                <span class="text-yellow-400">ğŸª</span> ì¿ í‚¤ 1ê°œ íšë“ (í…ŒìŠ¤íŠ¸ìš©)
                            </button>
                        </div>
                    </div>

                    ${adminLoginModal}
                    ${adminSettingsModal}
                    ${moodCheckModal}
                </div>
            `;
        };

        // --- ë©”ì¸ ë Œë” í•¨ìˆ˜ ---
        const render = () => {
            const appElement = document.getElementById('app');
            let html = '';

            // ê¸°ì¡´ì— ì¡´ì¬í•˜ëŠ” alert ëª¨ë‹¬ ì œê±°
            document.querySelectorAll('.alert-modal').forEach(el => el.remove());
            
            switch (globalState.view) {
                case 'intro':
                    html = renderIntro();
                    break;
                case 'test':
                    html = renderTest();
                    break;
                case 'naming':
                    html = renderNaming();
                    break;
                case 'main':
                    html = renderMain();
                    break;
                default:
                    html = '<div>ì˜¤ë¥˜: ì˜ëª»ëœ ë·° ìƒíƒœ</div>';
            }
            appElement.innerHTML = html;
            // createLucideIconsëŠ” DOMì— ì§ì ‘ ì•„ì´ì½˜ íƒœê·¸ë¥¼ ì‚½ì…í•˜ëŠ” ë°©ì‹ì´ë¯€ë¡œ, formatIconì„ ì‚¬ìš©í•  ë•ŒëŠ” í•„ìš” ì—†ìŠµë‹ˆë‹¤.
            // window.createLucideIcons(); 
        };
        
        // --- Custom Alert Modal ---
        const createAlertModal = (message) => {
            return `
                <div class="alert-modal fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center animate-fade-in">
                        <h3 class="font-bold text-lg text-slate-700 mb-4">ì•Œë¦¼</h3>
                        <p class="text-slate-600 mb-6">${message}</p>
                        <button 
                            onclick="document.querySelector('.alert-modal').remove()"
                            class="w-full py-3 text-white font-bold bg-sky-500 rounded-xl"
                        >
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            `;
        };

        // --- ì´ˆê¸°í™” ë¡œì§ ---
        window.onload = async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                appInstance = initializeApp(firebaseConfig);
                auth = getAuth(appInstance);
                db = getFirestore(appInstance);
            }

            // ì¸ì¦ ë° ì„¤ì • ë¡œë“œ
            if (auth) {
                const initAuth = async () => {
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (e) {
                            console.error("Custom Token Sign-in Failed:", e);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                await initAuth();
                
                onAuthStateChanged(auth, (user) => {
                    setState({ user });
                    // ì„¤ì •ê°’ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                    if (user) {
                        const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings');
                        const unsubscribe = onSnapshot(configRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                const newThresholds = data.thresholds || [0, 10, 30, 60, 100];
                                const newApiKey = data.apiKey || '';
                                setState({
                                    globalSettings: {
                                        apiKey: newApiKey,
                                        thresholds: newThresholds
                                    },
                                    adminApiKeyInput: newApiKey,
                                    adminThresholdsInput: newThresholds
                                });
                            }
                        }, (error) => {
                            console.error("ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                        });
                        globalState.unsubscribes.push(unsubscribe);
                    }
                });
            }
            render(); 
        };
    </script>
</body>
</html>